(window.webpackJsonp=window.webpackJsonp||[]).push([[64],{390:function(s,n,a){"use strict";a.r(n);var t=a(0),e=Object(t.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("blockquote",[n("p",[s._v("部署微服务")])]),s._v(" "),n("p",[s._v("如下图，用户通过域名访问到 Nginx，Nginx 反向代理到 SpringCloud Gateway 网关微服务，再由网关根据具体规则转发到不同的微服务。")]),s._v(" "),n("div",{staticClass:"language-txt line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-txt"}},[n("code",[s._v("\n\n                                                                  ┌────────────────┐\n                                                                  │                │\n                                                        ┌─────────►  MicroService  │\n                                                        │         │                │\n                    ┌────────┐       ┌──────────────┐   │         └────────────────┘\n                    │        │       │              │   │                 .\n     ┌──────┐       │        │       │  SpringCloud ├───┤                 .\n     │ User ├──────►│ Nginx  ├───────►    Gateway   │   │                 .\n     └──────┘       │        │       │              │   │         ┌────────────────┐\n                    └────────┘       └──────────────┘   │         │                │\n                                                        └─────────►  MicroService  │\n                                                                  │                │\n                                                                  └────────────────┘\n\n\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[s._v("虽然 SpringCloud Gateway 可以直接在80端口提供服务，但是 Nginx 可以高效地处理静态资源，两者功能有重叠部分，各自负责优势部分。")]),s._v(" "),n("h4",{attrs:{id:"_1-配置域名"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-配置域名"}},[s._v("#")]),s._v(" 1. 配置域名")]),s._v(" "),n("blockquote",[n("p",[s._v("User ---\x3e Nginx")])]),s._v(" "),n("p",[n("code",[s._v('> echo "yunmall.com YOUR_NGINX_SERVER_IP" >> /etc/hosts')])]),s._v(" "),n("h4",{attrs:{id:"_2-nginx-反向代理-gateway"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-nginx-反向代理-gateway"}},[s._v("#")]),s._v(" 2.Nginx 反向代理 Gateway")]),s._v(" "),n("blockquote",[n("p",[s._v("Nginx -> SpringCloud Gateway")])]),s._v(" "),n("p",[s._v("Nginx 反向代理 SpringCloud Gateway, 先要在 nginx 总配置文件 nginx.conf 中添加 "),n("em",[n("strong",[s._v("upstream")])]),s._v(" 配置块配置上游服务器。然后在虚拟主机配置文件中，将所有匹配的域名请求转发到网关。")]),s._v(" "),n("p",[n("font",{attrs:{color:"red"}},[s._v("Nginx 转发请求时会丢失域名信息,网关断言会失效，所以要设置转发域名。")]),s._v("详见"),n("code",[s._v("yunmall.conf@Line10")]),s._v(" ,其中 $host 代表 "),n("code",[s._v("server_name")]),s._v(" 配置项的值。")],1),s._v(" "),n("p",[n("em",[n("strong",[s._v("nginx.conf")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("....\nhttp {\n\t....\n\tupstream yunmall {\n\t\tserver 192.168.56.1:8888;  #YOUR_GATEWAY_SERVICE_IP\n\t}\n  include /etc/nginx/conf.d/*.conf;\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[n("em",[n("strong",[s._v("yunmall.conf")])])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("server {\n    listen       80;\n    server_name  gulimall.com;\n\n    #charset koi8-r;\n    #access_log  /var/log/nginx/log/host.access.log  main;\n\n    location / {\n    # Nginx 转发请求时，以 IP 方式而非域名方式转发给网关，所以需要配置设置头信息。\n      proxy_set_header Host $host;\n      proxy_pass http://gulimall;\n    }\n\n    #error_page  404              /404.html;\n\n    # redirect server error pages to the static page /50x.html\n    #\n    error_page   500 502 503 504  /50x.html;\n    location = /50x.html {\n        root   /usr/share/nginx/html;\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("h4",{attrs:{id:"_3-网关转发请求到微服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-网关转发请求到微服务"}},[s._v("#")]),s._v(" 3. 网关转发请求到微服务")]),s._v(" "),n("blockquote",[n("p",[s._v("SpringCloud Gateway ---\x3e MicroService")])]),s._v(" "),n("p",[n("em",[n("strong",[s._v("网关微服务配置文件： application.yml")])])]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spring")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n\t"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cloud")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n\t\t"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("gateway")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n\t\t\t"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("routes")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n\t\t\t\t"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("id")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" index_route\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("uri")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" lb"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//yunmall"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("product\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("predicates")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" Host=yunmall.com"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),n("span",{pre:!0,attrs:{class:"token important"}},[s._v("**.yunmall.com")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("h4",{attrs:{id:"_4-nginx-自行处理静态请求"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-nginx-自行处理静态请求"}},[s._v("#")]),s._v(" 4. Nginx 自行处理静态请求")]),s._v(" "),n("blockquote",[n("p",[s._v("SpringBoot 应用同样可以处理静态资源，但性能远不及 Nginx")])]),s._v(" "),n("p",[n("strong",[s._v("yunmall.conf")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("location /static/ {\n  root /user/share/nginx/html;\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("将所有的静态请求改为 "),n("code",[s._v("/static/")]),s._v(" 开头，Nginx 就会自动拦截并处理，这是 Nginx 的动静分离。")]),s._v(" "),n("h4",{attrs:{id:"_5-conclusion"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-conclusion"}},[s._v("#")]),s._v(" 5. Conclusion")]),s._v(" "),n("p",[s._v("记录简易微服务架构的部署，包含 Nginx 的动静分离和反向代理两个功能，也可在 "),n("code",[s._v("upstream")]),s._v(" 中定义多个网关，实现负载均衡。")])])}),[],!1,null,null,null);n.default=e.exports}}]);